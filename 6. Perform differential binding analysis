#Differential bindign analysis with DEseq2

#at R studio

#import black-list removed files
DM_CKO_peaks_counts_filtered <- read.delim("C:/Users/siwase/Dropbox/Documents/Manuscripts/KDM5C_KMT2A_DM/NatureCommunications/DM_ChIPseq/Kerimoglu_data/DM_CKO_peaks_counts_filtered.bed", header=FALSE)
DM_CKO_peaks_counts <- DM_CKO_peaks_counts_filtered
colnames(DM_CKO_peaks_counts) <- c('chr','start','end',
                                   'Kmt2a_Ctrl_rep1', 'Kmt2a_Ctrl_rep2', 'Kmt2a_Ctrl_rep3', 'Kmt2a_Ctrl_rep4', 'Kmt2a_Ctrl_rep5', 'Kmt2a_CKO_rep1', 'Kmt2a_CKO_rep2', 'Kmt2a_CKO_rep3',
                                   'Kmt2b_Ctrl_rep1', 'Kmt2b_Ctrl_rep2', 'Kmt2b_Ctrl_rep3', 'Kmt2b_Ctrl_rep4', 'Kmt2b_Ctrl_rep5', 'Kmt2b_CKO_rep1', 'Kmt2b_CKO_rep2', 'Kmt2b_CKO_rep3', 'Kmt2b_CKO_rep4', 'Kmt2b_CKO_rep5',
                                   'WT_rep1', 'WT_rep2', 'Kmt2a_HET_rep1', 'Kmt2a_HET_rep2', 'Kmt2a_HET_rep3', 'Kdm5c_KO_rep1', 'Kdm5c_KO_rep2', 'Kdm5c_KO_rep3', 'DM_rep1', 'DM_rep2', 'DM_rep3')

#add peaknames
n <- 29403
prefix <- "peak"
suffix <- seq(1:n)
peak.name <- paste(prefix,suffix,sep="")
DM_CKO_peaks_counts <- cbind(DM_CKO_peaks_counts, peak.name)

#remove Genomic Coordinates (GC)
DM_CKO_wo_GC <- DM_CKO_peaks_counts[ -c(1:3)]
row.names(DM_CKO_wo_GC) <- DM_CKO_wo_GC$peak.name
DM_CKO_wo_GC$peak.name <- NULL

#DEseq2analysis
library(DESeq2)
Design_1226 <- data.frame(row.names = colnames(DM_CKO_wo_GC), genotype = c("Kmt2a_Ctrl", "Kmt2a_Ctrl", "Kmt2a_Ctrl", "Kmt2a_Ctrl", "Kmt2a_Ctrl",
                                                                           "Kmt2a_CKO", "Kmt2a_CKO", "Kmt2a_CKO",
                                                                           "Kmt2b_Ctrl", "Kmt2b_Ctrl", "Kmt2b_Ctrl", "Kmt2b_Ctrl", "Kmt2b_Ctrl",
                                                                           "Kmt2b_CKO", "Kmt2b_CKO", "Kmt2b_CKO", "Kmt2b_CKO", "Kmt2b_CKO",
                                                                           "WT", "WT", "Kmt2a_HET", "Kmt2a_HET", "Kmt2a_HET", "Kdm5c_KO", "Kdm5c_KO", "Kdm5c_KO", "DM", "DM", "DM"),
                          sex = c("female", "male", "male", "female", "male", "male", "male", "female",
                                  "female", "female", "male", "male", "male", "female", "female", "female", "male", "male",
                                  "male", "male", "male", "male", "male", "male", "male", "male", "male", "male", "male"), 
                          brain_region = c("HIP", "HIP", "HIP", "HIP", "HIP", "HIP", "HIP", "HIP",
                                           "HIP", "HIP", "HIP", "HIP", "HIP", "HIP", "HIP", "HIP", "HIP", "HIP",
                                           "AMY", "AMY", "AMY", "AMY", "AMY", "AMY", "AMY", "AMY", "AMY", "AMY", "AMY"))

Design_1226
dds_1226 <- DESeqDataSetFromMatrix(DM_CKO_wo_GC, colData=Design_1226, design= ~ sex + genotype)
dds_1226_run <- DESeq(dds_1226, betaPrior = TRUE)

#PCA plots
vsd_1226 <- vst(dds_1226, blind = TRUE)  
head(assay(vsd_1226), 3)
library(ggplot2)
plotPCA(vsd_1226, intgroup = "genotype")
plotPCA(vsd_1226, intgroup = "sex")
plotPCA(vsd_1226, intgroup = "brain_region")

vsd_1226_local <- vst(dds_1226, blind = TRUE, fitType = 'local')  
head(assay(vsd_1226_local), 3)
library(ggplot2)
plotPCA(vsd_1226_local, intgroup = "genotype")
plotPCA(vsd_1226_local, intgroup = "sex")
plotPCA(vsd_1226_local, intgroup = "brain_region")

Restable_1226_2aCKOvsCtrl <- results(dds_1226_run, contrast=c("genotype", "Kmt2a_CKO", "Kmt2a_Ctrl"), alpha=0.2)
summary(Restable_1226_2aCKOvsCtrl)
Restable_1226_2bCKOvsCtrl <- results(dds_1226_run, contrast=c("genotype", "Kmt2b_CKO", "Kmt2b_Ctrl"), alpha=0.05)
summary(Restable_1226_2bCKOvsCtrl)
Restable_1226_5CKOvsCtrl <- results(dds_1226_run, contrast=c("genotype", "Kdm5c_KO", "WT"), alpha=0.05)
summary(Restable_1226_5CKOvsCtrl)
Restable_1226_2AHetvsCtrl <- results(dds_1226_run, contrast=c("genotype", "Kmt2a_HET", "WT"), alpha=0.05)
summary(Restable_1226_2AHetvsCtrl)
Restable_1226_DMvsCtrl <- results(dds_1226_run, contrast=c("genotype", "DM", "WT"), alpha=0.05)
summary(Restable_1226_DMvsCtrl)

#MA plot
par(mfrow=c(2,3))

plotMA(Restable_1226_2aCKOvsCtrl, ylim=c(-4,4), cex=.8)
plotMA(Restable_1226_2bCKOvsCtrl, ylim=c(-4,4), cex=.8)
plotMA(Restable_1226_2AHetvsCtrl, ylim=c(-4,4), cex=.8)
plotMA(Restable_1226_5CKOvsCtrl, ylim=c(-4,4), cex=.8)
plotMA(Restable_1226_DMvsCtrl, ylim=c(-4,4), cex=.8)
